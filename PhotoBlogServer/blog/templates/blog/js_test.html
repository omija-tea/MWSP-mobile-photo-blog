<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>API 테스트</title>
    <style>
        .json { white-space: pre-wrap; background: #f6f8fa; padding: 0.5rem; border-radius: 4px; }
        .thumb { max-width:120px; max-height:90px; }
    </style>
</head>
<body>
    <h1>API 테스트 페이지</h1>
    <h3>Client 가 사용할 API Endpoint를 fetch로 테스트: <code>/api_root/Post/</code></h3>
    <hr>
    <div class="top-controls">
        <p>인증 토큰 입력하기(Authorization: Token &lt;token&gt;)</p>
        <label>Token: <input type="text" id="token" size="40" placeholder="Token ..."></label>
        <button id="clearToken">Clear</button>
    </div>


    <hr>

    <section>
        <h2>게시물 목록</h2>
        <button id="reload">게시물 불러오기</button>
        <div id="list"></div>
    </section>

    <section>
        <h2>게시물 상세 정보 (리스트에서 클릭할것)</h2>
        <div id="detail"></div>
    </section>

    <hr>

    <section>
        <h2>새 게시물 생성</h2>
        <form id="createForm">
            <p><label>Title: <input name="title" placeholder="Title" required></label></p>
            <p><label>Text: <textarea name="text" placeholder="Text" rows="4" cols="50"></textarea></label></p>
            <p>Image: <input type="file" name="image" accept="image/*"></p>
            <p><button type="submit">Create</button></p>
        </form>
        <div id="createResult" class="json"></div>
    </section>

    <p><a href="{% url 'post_list' %}">돌아가기</a></p>

    <script>
        const listEl = document.getElementById('list');
        const detailEl = document.getElementById('detail');
        const reloadBtn = document.getElementById('reload');
        const createForm = document.getElementById('createForm');
        const createResult = document.getElementById('createResult');
        const clearTokenBtn = document.getElementById('clearToken');

        const API_BASE = '/api_root/Post/';

        function pretty(obj){
            return JSON.stringify(obj, null, 2);
        }

        function getAuthHeaders(){
            const headers = {};
            const token = document.getElementById('token').value.trim();
            if(token){
                headers['Authorization'] = 'Token ' + token;
            }
            return headers;
        }

        async function loadList(){
            listEl.textContent = '로딩...';
            try{
                const res = await fetch(API_BASE, { credentials: 'same-origin' });
                if(!res.ok){
                    listEl.innerHTML = `<div class="json">Error: ${res.status} ${res.statusText}</div>`;
                    return;
                }
                let data = await res.json();
                if (!Array.isArray(data)){
                    if (data.results) data = data.results;
                }
                renderList(data);
            }catch(err){
                listEl.innerHTML = `<div class="json">Fetch error: ${err}</div>`;
            }
        }

        function renderList(items){
            if(!items || items.length === 0){
                listEl.innerHTML = '<p>포스트 없음</p>';
                return;
            }
            const ul = document.createElement('ul');
            items.forEach(it => {
                const li = document.createElement('li');
                li.className = 'item';
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = `${it.id} - ${it.title}`;
                a.addEventListener('click', (e)=>{ e.preventDefault(); loadDetail(it.id); });
                li.appendChild(a);
                if(it.image){
                    const img = document.createElement('img');
                    img.src = it.image.startsWith('http') ? it.image : it.image;
                    img.className = 'thumb';
                    li.appendChild(document.createElement('br'));
                    li.appendChild(img);
                }
                ul.appendChild(li);
            });
            listEl.innerHTML = '';
            listEl.appendChild(ul);
        }

        async function loadDetail(id){
            detailEl.textContent = '로딩...';
            try{
                const res = await fetch(API_BASE + id + '/', { credentials: 'same-origin' });
                if(!res.ok){
                    detailEl.innerHTML = `<div class="json">Error: ${res.status} ${res.statusText}</div>`;
                    return;
                }
                const data = await res.json();

                // build detail HTML + controls
                let html = `<h3>${data.title} (id:${data.id})</h3>`;
                if(data.image) html += `<img src="${data.image}" class="thumb"><br>`;
                html += `<div class="json">${pretty(data)}</div>`;

                detailEl.innerHTML = html;

                // controls: Edit / Delete
                const controls = document.createElement('div');
                controls.className = 'controls';
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', ()=> showEditForm(data));
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.addEventListener('click', ()=> deletePost(data.id));
                controls.appendChild(editBtn);
                controls.appendChild(delBtn);
                detailEl.appendChild(controls);

            }catch(err){
                detailEl.innerHTML = `<div class="json">Fetch error: ${err}</div>`;
            }
        }

        function showEditForm(data){
            // remove existing edit form if any
            const existing = detailEl.querySelector('.edit-form');
            if(existing) existing.remove();

            const form = document.createElement('form');
            form.className = 'edit-form';
            form.innerHTML = `
                <p><input name="title" placeholder="Title" required></p>
                <p><textarea name="text" placeholder="Text" rows="4" cols="50"></textarea></p>
                <p>Image: <input type="file" name="image" accept="image/*"></p>
                <p>
                    <button type="submit">Save</button>
                    <button type="button" class="cancel">Cancel</button>
                </p>
                <div class="status json"></div>
            `;
            // prefill title/text
            form.elements['title'].value = data.title || '';
            form.elements['text'].value = data.text || '';

            form.querySelector('.cancel').addEventListener('click', ()=> form.remove());

            form.addEventListener('submit', (e)=>{
                e.preventDefault();
                const fd = new FormData(form);
                // If you want to explicitly remove image, you could add a flag field here.
                patchPost(data.id, fd, form.querySelector('.status'));
            });

            detailEl.appendChild(form);
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function patchPost(id, formData, statusEl = null){
            if(statusEl) statusEl.textContent = '전송 중...';
            const headers = getAuthHeaders();
            try{
                const res = await fetch(API_BASE + id + '/', {
                    method: 'PATCH',
                    headers: headers,
                    body: formData,
                    credentials: 'same-origin',
                });
                const text = await res.text();
                let parsed = text;
                try{ parsed = JSON.parse(text); } catch(e){}
                if(res.status >= 200 && res.status < 300){
                    if(statusEl) statusEl.innerHTML = `<div class="json">Updated: ${pretty(parsed)}</div>`;
                    // refresh list and detail
                    loadList();
                    loadDetail(id);
                } else {
                    if(statusEl) statusEl.innerHTML = `<div class="json">Error ${res.status}: ${pretty(parsed)}</div>`;
                }
            }catch(err){
                if(statusEl) statusEl.innerHTML = `<div class="json">Fetch error: ${err}</div>`;
            }
        }

        async function deletePost(id){
            if(!confirm('정말 삭제하시겠습니까?')) return;
            // show temporary message
            detailEl.querySelectorAll('.controls button').forEach(b => b.disabled = true);
            const headers = getAuthHeaders(true);
            try{
                const res = await fetch(API_BASE + id + '/', {
                    method: 'DELETE',
                    headers: headers,
                    credentials: 'same-origin',
                });
                if(res.status === 204 || (res.status >=200 && res.status < 300)){
                    detailEl.innerHTML = `<div class="json">Deleted post ${id}</div>`;
                    loadList();
                } else {
                    const text = await res.text();
                    let parsed = text;
                    try{ parsed = JSON.parse(text); } catch(e){}
                    detailEl.innerHTML = `<div class="json">Delete failed ${res.status}: ${pretty(parsed)}</div>`;
                    detailEl.querySelectorAll('.controls button').forEach(b => b.disabled = false);
                }
            }catch(err){
                detailEl.innerHTML = `<div class="json">Fetch error: ${err}</div>`;
            }
        }

        async function createPost(formData){
            createResult.textContent = '전송 중...';
            const headers = getAuthHeaders(true);

            try{
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: headers,
                    body: formData,
                    credentials: 'same-origin',
                });
                const text = await res.text();
                let parsed = text;
                try{ parsed = JSON.parse(text); } catch(e){}
                if(res.status >= 200 && res.status < 300){
                    createResult.innerHTML = `<div class="json">Created: ${pretty(parsed)}</div>`;
                    // refresh list
                    loadList();
                } else {
                    createResult.innerHTML = `<div class="json">Error ${res.status}: ${pretty(parsed)}</div>`;
                }
            }catch(err){
                createResult.innerHTML = `<div class="json">Fetch error: ${err}</div>`;
            }
        }

        reloadBtn.addEventListener('click', (e)=>{ e.preventDefault(); loadList(); });

        createForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            const fd = new FormData(createForm);
            createPost(fd);
        });

        clearTokenBtn.addEventListener('click', ()=>{ document.getElementById('token').value=''; });

        // initial load
        loadList();
    </script>
</body>
</html>